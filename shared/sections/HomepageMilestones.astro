---
import { COLORS, COLORSCLASSES } from '@config/styles'
import { mdxComponentsAstro } from '@shared/cms/components/mdxComponentsAstro.astro'
import Section from '@shared/layouts/Section.astro'
import { getCollection, getEntry, render } from 'astro:content'
import { clsx } from 'clsx'

const homepage = await getEntry('homepage', 'index')
if (homepage === undefined) return Astro.redirect('/404')

const homepageAfterMilestones = await getEntry('homepage', 'bodyaftermilestones')
if (homepageAfterMilestones === undefined) return Astro.redirect('/404')
const { Content: ContentAfterMilestones } = await render(homepageAfterMilestones)

// See https://github.com/withastro/docs/pull/8364/files#diff-a6fd5674a02c61d6110497ce6010118e4e9c6cfb50e3b5a9168faee52f77348dR483-R492
const homepageMilestones = await getCollection('homepageMilestones')
const milestones = []
for (const milestone of homepageMilestones) {
  const { Content } = await milestone.render()
  milestones.push({
    ...milestone.data,
    Content: Content,
  })
}
---

<Section prose>
  <h2>{homepage.data.titleMilestones}</h2>

  {
    milestones
      .sort((a, b) => a.position - b.position)
      .map(({ status, title, Content }) => {
        const commingUp = status === 'comingUp'

        return (
          <article class="group relative hyphens-auto text-balance pl-14">
            <header class="not-prose">
              <h3 class={commingUp ? 'text-gray-400' : COLORSCLASSES.milestoneHeadline}>
                <div
                  class={clsx(
                    'absolute bottom-0 left-4 top-0 w-1 border-l-2 group-last:hidden',
                    commingUp ? 'border-dashed' : '',
                  )}
                  style={{ borderColor: commingUp ? '#f2f2f2' : COLORS.milestoneDone }}
                  aria-hidden="true"
                />
                <div
                  class="absolute left-0 size-9 rounded-full"
                  style={{ backgroundColor: commingUp ? '#f2f2f2' : COLORS.milestoneDone }}
                  aria-hidden="true"
                />
                <div class="pt-0.5">{title}</div>
              </h3>
            </header>
            <div class={clsx('pb-10 prose-p:my-0', commingUp ? 'text-gray-400' : 'inherit')}>
              <Content components={mdxComponentsAstro} />
            </div>
          </article>
        )
      })
  }

  <ContentAfterMilestones components={mdxComponentsAstro} />
</Section>
